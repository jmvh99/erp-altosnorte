<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventario de Botellas • Altos Norte</title>
<meta name="description" content="App local para gestión de inventario de botellas entre bodegas y etapas de producción.">
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --muted:#7a7f8a; --accent:#4da3ff; --accent2:#66d19e;
    --text:#e9edf1; --warn:#ffcc66; --danger:#ff6b6b; --ok:#6be07b;
    --border:#262b36;
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b0d12,#10131b 25%,#0f1115);
    color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji"; line-height:1.45;
  }
  header{
    position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(10px);
    background:rgba(15,17,21,.6); border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1100px; margin:0 auto; padding:18px;}
  h1{font-size:1.3rem; margin:0;}
  .sub{color:var(--muted); font-size:.95rem}
  .grid{display:grid; gap:14px}
  @media(min-width:980px){ .grid.cols-3{ grid-template-columns: 1.2fr 1fr 1fr } }
  @media(min-width:980px){ .grid.cols-2{ grid-template-columns: 1.2fr 1fr } }
  section.panel{
    background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
    padding:16px;
  }
  section.panel h2{margin:.2rem 0 10px; font-size:1.05rem}
  label{display:block; font-size:.9rem; color:var(--muted); margin:10px 0 6px}
  input[type="text"], input[type="number"], select, textarea{
    width:100%; background:#0f131a; color:var(--text); border:1px solid #212634; border-radius:10px; padding:10px 12px;
    outline:none; transition:border .15s ease, box-shadow .15s ease;
  }
  input[type="number"]{ -moz-appearance:textfield }
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(77,163,255,.12); }
  button{
    background:var(--accent); border:none; color:#081018; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer;
  }
  button.secondary{ background:#232a38; color:var(--text); border:1px solid var(--border) }
  button.ghost{ background:transparent; color:var(--text); border:1px dashed var(--border) }
  button.warn{ background:var(--warn); color:#2a1a00 }
  button.danger{ background:var(--danger); color:#190306 }
  button.sm{ padding:6px 10px; border-radius:8px; font-size:.9rem }
  .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .rows{display:flex; gap:10px; flex-direction:column}
  table{width:100%; border-collapse:separate; border-spacing:0; font-size:.92rem}
  thead th{position:sticky; top:0; background:#0f131a; z-index:1}
  th, td{ padding:10px 10px; border-bottom:1px solid #1f2531; vertical-align:middle; }
  tr:hover td{ background:#121722 }
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:.82rem; border:1px solid var(--border);
    background:#101624;
  }
  .pill .dot{width:8px; height:8px; border-radius:50%}
  .tag{font-size:.8rem; color:var(--muted)}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .success{color:var(--ok)}
  .danger-t{color:var(--danger)}
  .toast{
    position:fixed; right:16px; bottom:16px; background:#121826; border:1px solid var(--border); padding:10px 14px; border-radius:10px;
    box-shadow:0 6px 30px rgba(0,0,0,.3); opacity:0; transform:translateY(10px); transition:.2s; z-index:99;
  }
  .toast.show{ opacity:1; transform:translateY(0) }
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0d111a; padding:2px 6px; border:1px solid #1f2531; border-radius:6px; font-size:.82rem }
  .hr{ height:1px; background:var(--border); margin:10px 0 }
  .note{ font-size:.9rem; color:var(--muted) }
  .footer{ color:var(--muted); text-align:center; padding:16px 0 40px }
  .chip{ background:#0f131a; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:.82rem }
  .search{ display:flex; gap:8px; }
  .search input{ flex:1 }
  .scroll{ max-height:300px; overflow:auto; border:1px solid var(--border); border-radius:10px }
  .nowrap{ white-space:nowrap }
</style>
</head>
<body>
<header>
  <div class="wrap inline">
    <div>
      <h1>Inventario de Botellas</h1>
      <div class="sub">Flujo entre bodegas y etapas • Guarda en tu navegador</div>
    </div>
    <div class="right inline">
      <button id="btnExportCSV" class="secondary sm" title="Exportar movimientos a CSV">Exportar CSV</button>
      <button id="btnBackup" class="secondary sm" title="Exportar respaldo JSON">Respaldar</button>
      <label for="restoreFile" class="ghost sm" style="cursor:pointer">Restaurar<input id="restoreFile" type="file" accept="application/json" style="display:none" /></label>
    </div>
  </div>
</header>

<main class="wrap grid cols-3">
  <section class="panel">
    <h2>Catálogo de Productos</h2>
    <div class="rows">
      <div class="inline">
        <div style="flex:1">
          <label>Nombre del producto</label>
          <input id="pName" type="text" placeholder="Ej. Pet-Nat Rosado 2024" />
        </div>
        <div style="width:180px">
          <label>SKU / Código</label>
          <input id="pSKU" type="text" placeholder="Ej. AN-PN24" />
        </div>
      </div>
      <div class="inline">
        <button id="addProduct">Agregar</button>
        <div class="note">Tip: presiona <span class="kbd">Enter</span> en el nombre para guardar.</div>
      </div>
      <div class="hr"></div>
      <div class="search">
        <input id="productSearch" type="text" placeholder="Buscar…" />
        <span class="chip" id="productCount">0 productos</span>
      </div>
      <div class="scroll">
        <table id="productTable">
          <thead><tr><th>Producto</th><th>SKU</th><th class="right">Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>Alta de Stock (lotes)</h2>
    <div class="rows">
      <label>Producto</label>
      <select id="sProduct"></select>
      <div class="inline">
        <div style="flex:1">
          <label>Bodega</label>
          <select id="sWarehouse"></select>
        </div>
        <div style="flex:1">
          <label>Etapa</label>
          <select id="sStage"></select>
        </div>
      </div>
      <div class="inline">
        <div style="flex:1">
          <label>Cantidad (botellas)</label>
          <input id="sQty" type="number" min="1" step="1" placeholder="Ej. 120" />
        </div>
        <div style="flex:1">
          <label>Lote (opcional)</label>
          <input id="sLot" type="text" placeholder="Ej. L2407-R1" />
        </div>
      </div>
      <label>Notas (opcional)</label>
      <input id="sNotes" type="text" placeholder="Ej. Transferencia inicial / conteo físico" />
      <div class="inline">
        <button id="addStock">Agregar stock</button>
        <button id="recount" class="secondary">Recontar totales</button>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>Movimiento</h2>
    <div class="rows">
      <label>Producto</label>
      <select id="mProduct"></select>
      <div class="inline">
        <div style="flex:1">
          <label>Desde bodega</label>
          <select id="mFrom"></select>
        </div>
        <div style="flex:1">
          <label>Hacia bodega</label>
          <select id="mTo"></select>
        </div>
      </div>
      <div class="inline">
        <div style="flex:1">
          <label>Cambiar etapa (opcional)</label>
          <select id="mStage">
            <option value="">— Mantener —</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Cantidad</label>
          <input id="mQty" type="number" min="1" step="1" />
        </div>
      </div>
      <label>Notas (opcional)</label>
      <input id="mNotes" type="text" placeholder="Motivo / referencia" />
      <div class="inline">
        <button id="doMove">Mover</button>
        <span class="note">Los movimientos quedan en el historial.</span>
      </div>
    </div>
  </section>

  <section class="panel" style="grid-column:1 / -1">
    <h2>Resumen por bodega y etapa</h2>
    <div class="toolbar" style="margin-bottom:10px">
      <div class="inline">
        <span class="tag">Filtrar</span>
        <select id="fWarehouse"></select>
        <select id="fStage"></select>
        <input id="fText" type="text" placeholder="Producto/SKU/Lote…" style="min-width:240px" />
      </div>
      <div class="right inline">
        <button id="btnClearFilters" class="secondary sm">Limpiar filtros</button>
      </div>
    </div>
    <div class="scroll" style="max-height:360px">
      <table id="stockTable">
        <thead>
          <tr>
            <th>Producto</th><th>SKU</th><th>Bodega</th><th>Etapa</th><th class="nowrap">Lote</th><th class="right">Cantidad</th><th class="right">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="panel" style="grid-column:1 / -1">
    <h2>Historial de movimientos</h2>
    <div class="toolbar" style="margin-bottom:10px">
      <div class="inline">
        <span class="tag">Rango</span>
        <input id="hFrom" type="date" />
        <input id="hTo" type="date" />
      </div>
      <div class="right inline">
        <button id="btnClearDates" class="secondary sm">Limpiar rango</button>
      </div>
    </div>
    <div class="scroll" style="max-height:320px">
      <table id="histTable">
        <thead>
          <tr>
            <th>Fecha</th><th>Producto</th><th>Desde</th><th>Hacia</th><th>Etapa</th><th>Cantidad</th><th>Notas</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <div class="footer" style="grid-column:1 / -1">
    Hecho con cariño para manejar botellas entre bodegas • Guarda todo en tu navegador (LocalStorage).
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
const STAGES = ["Embotellado","Degollado","Producto terminado"];
const WAREHOUSES = ["Bodega en medio","Bodega chica","Bodega externa","Bodega casa","Espacio AN","Oficina"];
const DB_KEY = "an_inventory_db_v1";

let db = { products: [], stock: [], moves: [] };

const $ = (sel) => document.querySelector(sel);
function uid(){ return Math.random().toString(36).slice(2,9) }
function fmt(n){ return new Intl.NumberFormat('es-MX').format(n) }
function nowISO(){ return new Date().toISOString() }
function showToast(msg){ const t=document.getElementById("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 2000) }
function save(){ localStorage.setItem(DB_KEY, JSON.stringify(db)) }
function load(){
  const raw = localStorage.getItem(DB_KEY);
  if(raw){
    try{ db = JSON.parse(raw) }catch(e){ console.error(e) }
  }else{
    db.products = [
      {id:uid(), name:"Pet-Nat Rosado 2024", sku:"AN-PN24"},
      {id:uid(), name:"Espumoso Tradicional 2023", sku:"AN-ET23"},
      {id:uid(), name:"Tinto Natural 2022", sku:"AN-TN22"},
    ];
    const p1 = db.products[0].id, p2 = db.products[1].id, p3 = db.products[2].id;
    db.stock = [
      {id:uid(), productId:p1, warehouse:"Bodega en medio", stage:"Embotellado", qty:120, lot:"L2407-R1", notes:"Ingreso inicial"},
      {id:uid(), productId:p2, warehouse:"Bodega externa", stage:"Degollado", qty:80, lot:"L2311-B", notes:"Reposición"},
      {id:uid(), productId:p3, warehouse:"Oficina", stage:"Producto terminado", qty:24, lot:"L2209-NAT", notes:"Muestras"},
    ];
    save();
  }
}
function fillSelectOptions(sel, arr, includeBlank=false){
  sel.innerHTML = includeBlank ? '<option value=""></option>' : "";
  for(const v of arr){ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); }
}
function fillProductsSelect(sel, includeBlank=false){
  sel.innerHTML = includeBlank ? '<option value=""></option>' : "";
  for(const p of db.products){ const o=document.createElement("option"); o.value=p.id; o.textContent=p.name; sel.appendChild(o); }
}
function productById(id){ return db.products.find(p=>p.id===id) }
function renderProducts(){
  const tbody = document.querySelector("#productTable tbody");
  const q = document.getElementById("productSearch").value.trim().toLowerCase();
  tbody.innerHTML = ""; let count=0;
  for(const p of db.products){
    const hit = [p.name,p.sku].join(" ").toLowerCase().includes(q);
    if(!hit) continue; count++;
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${p.name}</td><td class="muted">${p.sku||""}</td>
      <td class="right"><button class="sm secondary" data-act="del" data-id="${p.id}">Eliminar</button></td>`;
    tbody.appendChild(tr);
  }
  document.getElementById("productCount").textContent = `${count} producto${count!==1?"s":""}`;
  tbody.onclick = (e)=>{
    const btn = e.target.closest("button[data-act='del']"); if(!btn) return;
    const id = btn.getAttribute("data-id");
    if(confirm("¿Eliminar producto? Se mantendrán los registros históricos.")){
      db.products = db.products.filter(p=>p.id!==id); save(); refreshAll(); showToast("Producto eliminado");
    }
  };
  [document.getElementById("sProduct"), document.getElementById("mProduct")].forEach(sel => fillProductsSelect(sel));
}
function renderStock(){
  const tbody = document.querySelector("#stockTable tbody");
  const wh = document.getElementById("fWarehouse").value;
  const st = document.getElementById("fStage").value;
  const txt = document.getElementById("fText").value.trim().toLowerCase();
  tbody.innerHTML = "";
  const rows=[];
  for(const s of db.stock){
    const p = productById(s.productId) || {name:"(eliminado)", sku:""};
    const key=[s.productId,s.warehouse,s.stage,s.lot||""].join("|");
    let row=rows.find(r=>r.key===key);
    if(!row){ row={key, productId:s.productId, product:p, warehouse:s.warehouse, stage:s.stage, lot:s.lot||"", qty:0}; rows.push(row); }
    row.qty += s.qty;
  }
  const filtered = rows.filter(r=>{
    if(wh && r.warehouse!==wh) return false;
    if(st && r.stage!==st) return false;
    const blob=[r.product.name,r.product.sku,r.lot].join(" ").toLowerCase();
    if(txt && !blob.includes(txt)) return false; return true;
  }).sort((a,b)=> a.product.name.localeCompare(b.product.name));
  for(const r of filtered){
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${r.product.name}</td>
      <td class="muted">${r.product.sku||""}</td>
      <td>${r.warehouse}</td>
      <td><span class="pill"><span class="dot" style="background:${stageColor(r.stage)}"></span>${r.stage}</span></td>
      <td class="muted">${r.lot||""}</td>
      <td class="right">${fmt(r.qty)}</td>
      <td class="right"><button class="sm secondary" data-act="split" data-key="${r.key}">Ajustar / dividir</button></td>`;
    tbody.appendChild(tr);
  }
  tbody.onclick = (e)=>{
    const btn=e.target.closest("button[data-act='split']"); if(!btn) return;
    const key=btn.getAttribute("data-key"); openSplitDialog(key);
  };
}
function stageColor(stage){
  switch(stage){ case "Embotellado": return "#66d19e"; case "Degollado": return "#ffcc66"; case "Producto terminado": return "#4da3ff"; default: return "#7a7f8a"; }
}
function renderHistory(){
  const tbody = document.querySelector("#histTable tbody");
  const dFrom = document.getElementById("hFrom").value ? new Date(document.getElementById("hFrom").value) : null;
  const dTo = document.getElementById("hTo").value ? new Date(document.getElementById("hTo").value) : null;
  tbody.innerHTML = "";
  const rows = db.moves.slice().sort((a,b)=> b.ts.localeCompare(a.ts));
  for(const m of rows){
    const dt=new Date(m.ts);
    if(dFrom && dt < new Date(dFrom.getFullYear(), dFrom.getMonth(), dFrom.getDate())) continue;
    if(dTo && dt > new Date(dTo.getFullYear(), dTo.getMonth(), dTo.getDate(), 23,59,59)) continue;
    const p = productById(m.productId) || {name:"(eliminado)"};
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${dt.toLocaleString()}</td>
      <td>${p.name}</td>
      <td>${m.from||"—"}</td>
      <td>${m.to||"—"}</td>
      <td>${m.stage||"—"}</td>
      <td>${fmt(m.qty)}</td>
      <td class="muted">${m.notes||""}</td>`;
    tbody.appendChild(tr);
  }
}
function addProduct(){
  const name=document.getElementById("pName").value.trim();
  if(!name){ showToast("Nombre requerido"); return }
  const sku=document.getElementById("pSKU").value.trim();
  db.products.push({id:uid(), name, sku});
  document.getElementById("pName").value=""; document.getElementById("pSKU").value="";
  save(); refreshAll(); showToast("Producto agregado");
}
function addStock(){
  const productId=document.getElementById("sProduct").value;
  const warehouse=document.getElementById("sWarehouse").value;
  const stage=document.getElementById("sStage").value;
  const qty=parseInt(document.getElementById("sQty").value,10);
  const lot=document.getElementById("sLot").value.trim();
  const notes=document.getElementById("sNotes").value.trim();
  if(!productId){ showToast("Selecciona un producto"); return }
  if(!warehouse || !stage){ showToast("Selecciona bodega y etapa"); return }
  if(!(qty>0)){ showToast("Cantidad inválida"); return }
  db.stock.push({id:uid(), productId, warehouse, stage, qty, lot, notes});
  db.moves.push({ts:nowISO(), productId, from:"(alta)", to:warehouse, stage, qty, notes: notes||"Alta de stock"});
  document.getElementById("sQty").value=""; document.getElementById("sLot").value=""; document.getElementById("sNotes").value="";
  save(); refreshAll(); showToast("Stock agregado");
}
function doMove(){
  const productId=document.getElementById("mProduct").value;
  const from=document.getElementById("mFrom").value;
  const to=document.getElementById("mTo").value;
  const stageNew=document.getElementById("mStage").value;
  const qty=parseInt(document.getElementById("mQty").value,10);
  const notes=document.getElementById("mNotes").value.trim();
  if(!productId){ showToast("Selecciona un producto"); return }
  if(!from || !to){ showToast("Selecciona bodegas"); return }
  if(from===to && !stageNew){ showToast("Cambia etapa o bodega"); return }
  if(!(qty>0)){ showToast("Cantidad inválida"); return }
  const candidates = db.stock.filter(s=> s.productId===productId && s.warehouse===from);
  if(candidates.length===0){ showToast("No hay stock en bodega origen"); return }
  let remaining=qty;
  const stageOrder=(st)=> STAGES.indexOf(st);
  candidates.sort((a,b)=> stageOrder(a.stage)-stageOrder(b.stage));
  let stageApplied = stageNew || null;
  const consumed=[];
  for(const row of candidates){
    const take=Math.min(row.qty, remaining);
    if(take>0){ row.qty-=take; consumed.push({stage:row.stage, qty:take, lot:row.lot}); remaining-=take; if(stageApplied===null) stageApplied=row.stage; }
    if(remaining===0) break;
  }
  db.stock = db.stock.filter(s=> s.qty>0);
  if(remaining>0){ showToast("Stock insuficiente en origen"); return; }
  const finalStage = stageNew || stageApplied || STAGES[0];
  const lotNote = consumed.map(c=>c.lot?c.lot:"").filter(Boolean).join(",");
  db.stock.push({id:uid(), productId, warehouse:to, stage:finalStage, qty:qty, lot: lotNote?("mix:"+lotNote):"", notes});
  db.moves.push({ts:nowISO(), productId, from, to, stage: finalStage + (stageNew?" (cambio)":"") , qty, notes});
  document.getElementById("mQty").value=""; document.getElementById("mNotes").value="";
  save(); refreshAll(); showToast("Movimiento registrado");
}
function openSplitDialog(key){
  const [productId, warehouse, stage, lot] = key.split("|");
  const currentQty = db.stock.filter(s => s.productId===productId && s.warehouse===warehouse && s.stage===stage && (s.lot||"")===lot).reduce((a,b)=>a+b.qty,0);
  const p = productById(productId) || {name:"(eliminado)"};
  const inp = prompt(`Ajustar/DIVIDIR\n${p.name}\n${warehouse} • ${stage}${lot?(" • Lote "+lot):""}\nCantidad actual: ${currentQty}\n\nIngresa nueva cantidad (para dejar en este registro). Si reduces, se quitará la diferencia.\nPara dividir, escribe "nueva_bodega,nueva_etapa,cantidad" (ej: "Oficina,Producto terminado,12")`);
  if(!inp) return;
  if(inp.includes(",")){
    const parts = inp.split(",").map(x=>x.trim());
    if(parts.length<3){ showToast("Formato inválido"); return }
    const newWh = parts[0]; const newSt = parts[1]; const qty = parseInt(parts[2],10);
    if(!WAREHOUSES.includes(newWh) || !STAGES.includes(newSt) || !(qty>0)){ showToast("Datos inválidos"); return }
    const available = currentQty; if(qty>available){ showToast("Cantidad excede el disponible"); return }
    let remaining = qty;
    for(const row of db.stock){
      if(row.productId===productId && row.warehouse===warehouse && row.stage===stage && (row.lot||"")===lot){
        const take=Math.min(row.qty, remaining); row.qty-=take; remaining-=take; if(remaining===0) break;
      }
    }
    db.stock = db.stock.filter(s=> s.qty>0);
    db.stock.push({id:uid(), productId, warehouse:newWh, stage:newSt, qty, lot: lot?("sub:"+lot):"", notes:"División manual"});
    db.moves.push({ts:nowISO(), productId, from:warehouse, to:newWh, stage:newSt+" (división)", qty, notes:"División manual"});
    save(); refreshAll(); showToast("División creada");
  }else{
    const newQty = parseInt(inp,10);
    if(!Number.isFinite(newQty) || newQty<0){ showToast("Cantidad inválida"); return }
    const diff = newQty - currentQty;
    if(diff===0){ showToast("Sin cambios"); return }
    if(diff>0){
      db.stock.push({id:uid(), productId, warehouse, stage, qty:diff, lot, notes:"Ajuste +"});
      db.moves.push({ts:nowISO(), productId, from:"(ajuste +)", to:warehouse, stage, qty:diff, notes:"Ajuste positivo"});
    }else{
      let remaining=-diff;
      for(const row of db.stock){
        if(row.productId===productId && row.warehouse===warehouse && row.stage===stage && (row.lot||"")===lot){
          const take=Math.min(row.qty, remaining); row.qty-=take; remaining-=take; if(remaining===0) break;
        }
      }
      db.stock = db.stock.filter(s=> s.qty>0);
      db.moves.push({ts:nowISO(), productId, from:warehouse, to:"(ajuste -)", stage, qty:-diff, notes:"Ajuste negativo"});
    }
    save(); refreshAll(); showToast("Ajuste realizado");
  }
}
function exportCSV(){
  const rows=[["fecha","producto","desde","hacia","etapa","cantidad","notas"]];
  for(const m of db.moves){ const p=productById(m.productId) || {name:"(eliminado)"}; rows.push([m.ts,p.name,m.from||"",m.to||"",m.stage||"",m.qty,(m.notes||"").replace(/[\r\n]+/g," ")]); }
  const csv=rows.map(r=> r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  downloadFile("movimientos.csv","text/csv;charset=utf-8",csv);
}
function backupJSON(){ downloadFile("inventario_backup.json","application/json;charset=utf-8", JSON.stringify(db,null,2)); }
function restoreJSON(file){
  const reader=new FileReader();
  reader.onload=(e)=>{ try{ const obj=JSON.parse(e.target.result); if(!obj.products||!obj.stock||!obj.moves) throw new Error("Estructura inválida"); db=obj; save(); refreshAll(); showToast("Restaurado"); }catch(err){ alert("Archivo inválido: "+err.message) } };
  reader.readAsText(file);
}
function downloadFile(name,mime,content){
  const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([content],{type:mime})); a.download=name; document.body.appendChild(a); a.click(); a.remove();
}
function resetFilters(){
  document.getElementById("fWarehouse").value=""; document.getElementById("fStage").value=""; document.getElementById("fText").value="";
  document.getElementById("hFrom").value=""; document.getElementById("hTo").value="";
  renderStock(); renderHistory();
}
function refreshAll(){
  renderProducts();
  fillSelectOptions(document.getElementById("sWarehouse"), WAREHOUSES);
  fillSelectOptions(document.getElementById("mFrom"), WAREHOUSES, true);
  fillSelectOptions(document.getElementById("mTo"), WAREHOUSES, true);
  fillSelectOptions(document.getElementById("fWarehouse"), ["", ...WAREHOUSES]);
  fillSelectOptions(document.getElementById("sStage"), STAGES);
  fillSelectOptions(document.getElementById("fStage"), ["", ...STAGES]);
  const mStage=document.getElementById("mStage"); mStage.innerHTML='<option value="">— Mantener —</option>'; STAGES.forEach(s=>{ const o=document.createElement("option"); o.value=s; o.textContent=s; mStage.appendChild(o); });
  fillProductsSelect(document.getElementById("sProduct"));
  fillProductsSelect(document.getElementById("mProduct"));
  renderStock(); renderHistory();
}
function wire(){
  document.getElementById("addProduct").onclick=addProduct;
  document.getElementById("pName").addEventListener("keydown",(e)=>{ if(e.key==="Enter") addProduct() });
  document.getElementById("productSearch").oninput=renderProducts;
  document.getElementById("addStock").onclick=addStock;
  document.getElementById("recount").onclick=()=>{ renderStock(); showToast("Totales recalculados") };
  document.getElementById("doMove").onclick=doMove;
  document.getElementById("fWarehouse").onchange=renderStock;
  document.getElementById("fStage").onchange=renderStock;
  document.getElementById("fText").oninput=renderStock;
  document.getElementById("btnClearFilters").onclick=resetFilters;
  document.getElementById("btnClearDates").onclick=resetFilters;
  document.getElementById("btnExportCSV").onclick=exportCSV;
  document.getElementById("btnBackup").onclick=backupJSON;
  document.getElementById("restoreFile").onchange=(e)=> e.target.files[0] && restoreJSON(e.target.files[0]);
}
load(); wire(); refreshAll();
</script>
</body>
</html>
